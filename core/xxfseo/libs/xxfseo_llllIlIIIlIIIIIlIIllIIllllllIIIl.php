<?php
 class view{public $template; private $group; public $options; function __construct(){$this->template=new template; $this->group=defined('GROUP_NAME')?GROUP_NAME:config('DEFAULT_GROUP'); $theme=$this->getTemplateTheme(); $this->options=array(); $this->options['compile_check']=config('TMPL_COMPILE_CHECK'); $this->options['caching']=config('HTML_CACHE'); $this->options['tpl_path']=config('TMPL_PATH') ? config('TMPL_PATH') : TMPL_PATH; $this->options['template_dir']=$this->options['tpl_path'].$this->group.'/'.$theme; $this->options['cache_dir']=CACHE_PATH.'html'; $this->options['compile_dir']=TPLCACHE_PATH.$this->group.'/'.$theme; $this->options['cache_id']=''; $this->options['cache_first']=false; $this->options['cache_html_user_hashdir']=config('HTML_CACHE_USE_HASHDIR'); $this->options['cache_html_hashdir_level']=config('HTML_CACHE_HASHDIR_LEVEL'); $this->options['force_compile']=false; $this->initialize(); } private function initialize(){$this->template->debugging=false; $this->template->compile_check=$this->options['compile_check']; $this->template->plugins_dir=APPLIB_PATH.'tpltags/'; $this->template->force_compile=$this->options['force_compile']; $this->template->template_dir=$this->options['template_dir']; $this->template->compile_dir=$this->options['compile_dir']; $this->template->caching=false; $this->template->cache_dir=$this->options['cache_dir']; $this->template->left_delimiter='{'; $this->template->right_delimiter='}'; } public function assign($name,$value=''){$this->template->assign($name,$value); } public function fetch($templateFile=''){if(strncmp($templateFile, 'str:', 4) == 0){return $this->template->fetch($templateFile); } if(!is_file($templateFile)){$file=$this->getTemplate(); if($templateFile){if(MODULE_NAME!=config('DEFAULT_MODULE')){if(ACTION_NAME==config('DEFAULT_ACTION')){$templateFile=MODULE_NAME; }else{$templateFile=MODULE_NAME.'_'.$templateFile; } } $templateFile=dirname($file).'/'.$templateFile.config('TMPL_TEMPLATE_SUFFIX'); }else{$templateFile=$file; } } if(!is_file($templateFile)){exception('模板不存在:'.$templateFile); } return $this->template->fetch($templateFile); } public function get($name=''){return $this->template->getTemplateVars($name); } public function getTemplate($template=''){if(ACTION_NAME==config('DEFAULT_ACTION')){$default_template=MODULE_NAME; }else{$default_template=MODULE_NAME.'_'.ACTION_NAME; } define('THEME_PATH',$this->options['template_dir'].'/'); if($template){$template=THEME_PATH.$template.config('TMPL_TEMPLATE_SUFFIX'); }else{$template=THEME_PATH.$default_template.config('TMPL_TEMPLATE_SUFFIX'); } return $template; } public function display($templateFile=''){$this->initialize(); if(!is_file($templateFile)){$templateFile=$this->getTemplate($templateFile); } $GLOBALS['first_compile']=true; $cacheid=$this->options['cache_id']; $_cache_file=$this->getHtmlPath($cacheid); if($this->options['cache_first'] && $_cache_file && is_file($_cache_file)){$return_html=file_get_contents($_cache_file); if(substr($return_html,0,16)=='xxfseo_cachegzip'){$return_html=gzinflate(substr($return_html,16)); } echo $return_html; return true; } if($_cache_file && $this->options['caching']){$_cache_life_time=$this->options['cache_lifetime']; if(!is_file($_cache_file) || (filemtime($_cache_file)+$_cache_life_time)<time()){$_cache_dirs=dirname($_cache_file); if(!is_dir($_cache_dirs)) mkdir($_cache_dirs,0766,true); ob_start(); $this->template->display($templateFile); $_cache_html=ob_get_contents(); ob_end_clean(); $GLOBALS['linktag_display']=true; $GLOBALS['first_compile']=false; $_cache_html=$this->template->fetch_str($_cache_html); $return_html=$this->fetch('str:'.$_cache_html); if(config('web_cache_gzip')){$_cache_html='xxfseo_cachegzip'.gzdeflate($_cache_html, 9); } file_put_contents($_cache_file,$_cache_html); }else{$return_html=file_get_contents($_cache_file); if(substr($return_html,0,16)=='xxfseo_cachegzip'){if($return_html2=gzinflate(substr($return_html,16))){$return_html=$return_html2; }else{$return_html=substr($return_html,16); } } $return_html=$this->fetch('str:'.$return_html); } echo $return_html; }else{$GLOBALS['linktag_display']=true; $GLOBALS['first_compile']=false; $this->template->compile_check=true; debug_log('displayfile_'.$templateFile); $this->template->display($templateFile); debug_log('displayfile_'.$templateFile,'end'); } } public function __call($name,$args){$method=new ReflectionMethod($this->template,$name); $method->invokeArgs($this->template,$args); } private function getTemplateTheme(){$theme=config('DEFAULT_THEME'); define('THEME_NAME',$theme); return $theme ? $theme.'/':''; } public function getHtmlPath($cacheid,$cache_dir=false){if($cacheid==''){return ''; } if(config('web_cachefile_type')==2){$cache_dir=$cache_dir ? $cache_dir : CACHE_PATH.'htmlfile'; $cache_file=preg_replace('~^https?://~','',thisurl()); $cache_file=preg_replace('~^www\.~','',$cache_file); list($cache_file,)=explode('?',$cache_file); list($cache_file,)=explode('&',$cache_file); if(substr($cache_file,-1)=='/' || strpos(basename($cache_file),'.')===false){$cache_file=rtrim($cache_file,'/').'/index.html'; } $cache_file=$cache_dir.'/'.$cache_file; }else{$path=$this->options['cache_html_user_hashdir'] ? getHashDir($cacheid,$this->options['cache_html_hashdir_level']) : ''; $cache_dir=$cache_dir ? $cache_dir : $this->options['cache_dir']; $cache_dir=rtrim($cache_dir,'/').'/'.$path.'/'; $cache_file=$cache_dir.$cacheid.config('HTML_CACHE_SUFFIX'); } return $cache_file; } public function isCached(){$_cache_file=$this->getHtmlPath($this->options['cache_id']); if($this->options['cache_first'] && is_file($_cache_file)){return true; } if($this->options['caching']){$_cache_life_time=$this->options['cache_lifetime']; if(is_file($_cache_file) && (filemtime($_cache_file)+$_cache_life_time)>time()){return true; } } return false; } }